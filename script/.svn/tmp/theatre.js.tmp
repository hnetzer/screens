dojo.require("dijit.form.TextBox");
dojo.require("dijit.form.Button");


var THEATRE_CONTROLLER = 'controllers/theatre_controller.php';
var SEARCH_CONTROLLER = 'controllers/search_controller.php';

dojo.addOnLoad(function() {

<<<<<<< .mine
	//getTheaterName();
	//getUsersInTheatre();
	setUpEmbededSWF();
	
=======
	getTheaterName();
	//getUsersInTheatre();
	setUpEmbededSWF();
	
>>>>>>> .r162
	dojo.addOnWindowUnload(function() {
		exitTheatre();
	});	
});

function getTheaterName(){
	
	callServerPost(THEATRE_CONTROLLER, { method: 'get_theatre_info'}, showTopic, 'GETTING THEATRE INFO');
	function showTopic(jsonTheatre) {
		dojo.byId('id_theatreTopic').innerHTML = jsonTheatre.topic;
	}
}


function exitTheatre(){
	callServerPostSync(THEATRE_CONTROLLER, {method: 'exit_theatre'}, confirmLeft, 'EXITING THEATRE' );
	function confirmLeft(id){
		console.log(id);
	}	
}

function getUsersInTheatre(){
	
	callServerPost(THEATRE_CONTROLLER, { method: 'get_users_in_theatre'}, showUsersInTheatre, 'GETTING USERS IN THEATRE');
	function showUsersInTheatre(jsonUser) {//array of usernames
		//jsonUser[i].username
		console.log(jsonUser);
		//dojo.byId('id_usersInTheatre').innerHTML = jsonUser.topic;
	}
}



function setUpEmbededSWF(){
	
	console.log("setting up");
	
	var params = { allowScriptAccess: "always" };
	var atts = { id: "myytplayer" };
	console.log("here");

	swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&version=3&playerapiid=ytplayer",
	                   "ytapiplayer", "680", "400", "8", null, null, params, atts);
	
}

function onYouTubePlayerReady(playerId){

	console.log("set up");
	   ytplayer = document.getElementById("myytplayer");//get reference to the player
	   ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
	   
	   getReelPreview();
	   initializeReel();
	   
}

function initializeReel(){
	callServerPost(THEATRE_CONTROLLER, { method: 'get_initial_reel'}, reelResponse, 'GETTING NEXT VIDEO');
	function reelResponse(jsonReel){
		if(jsonReel){
			//exists playable video, begin playing it
			console.log(jsonReel.url);
			console.log(jsonReel.start_time);
			dojo.attr('id_hidden_reel', 'value', jsonReel.id);
			play(jsonReel.url, jsonReel.start_time);
		}		
	}
}

function onytplayerStateChange(newState) {

	if(newState==0){
		   console.log("video finished");
		   loadNextVideo();
	}
}

function loadNextVideo(){
	
	//ask database for next video
	callServerPostForm(THEATRE_CONTROLLER, { method: 'get_next_reel'}, getNextVideo, 'GETTING NEXT VIDEO', 'id_nextVideo');
	function getNextVideo(jsonReel) {

		dojo.attr('id_hidden_reel', 'value', jsonReel.id);
		//document.getElementById('now_playing').innerHTML = 'Now Playing:  ' + jsonReel.title;
		play(jsonReel.url, 0);
	}
}

function getReelPreview(){
	callServerPost(THEATRE_CONTROLLER, { method: 'get_reel_preview'}, reelResponse, 'GETTING REEL PREVIEW');
	function reelResponse(jsonReels){
		if(jsonReels){
			for(i=0; i<jsonReels.length; i++) {
				
				var idDiv = dojo.create("div", {innerHTML: jsonReels[i].title, class:'reelId' });
				dojo.place(idDiv, dojo.byId('id_reelPreview'));
			}
		}		
	}
}

function play(videoId, startPoint){
	if(ytplayer){
		console.log(videoId);
		console.log(startPoint);
		ytplayer.loadVideoById(videoId, startPoint, "medium");
	}
	else{
		console.log("failed to play");
	}
}

function addUrlToPlaylist() {
	
	//get ID out of url
	var url = dojo.attr("new_url", "value");
	var video_id = url.split('v=')[1];
	var ampersandPosition = video_id.indexOf('&');
	if(ampersandPosition != -1){
		video_id = video_id.substring(0, ampersandPosition);
	}
	
	//add ID to database
	newId = video_id;
	var params = { method: 'add_to_playlist', url: newId };
	callServerPostText(THEATRE_CONTROLLER, params , showInPlaylist, 'ADDING VIDEO');
	

}

function showInPlaylist(jsonRT) {
	
	dojo.byId("id_newUrlForm").reset();
	
	//if theater has no videos playing
	if(dojo.attr('id_hidden_reel', 'value') == 0){
		play(newId, 0);
		dojo.attr('id_hidden_reel', 'value', jsonRT.id);
	}
	//ytplayer.loadVideoById(videoId, 0, "medium");
}

function mute(){
	
	if(ytplayer.isMuted()){
		ytplayer.unMute();
		document.getElementById('mute_button').innerHTML = 'Mute';
	}
	else{
		ytplayer.mute();
		document.getElementById('mute_button').innerHTML = 'unMute';	
	}
}

function volumeUp(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 100){
		ytplayer.setVolume(vol+10);
	}
}

function volumeDown(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 0){
		console.log("setting volume");
		ytplayer.setVolume(vol-10);
	}
}

function voteUp(){
	callServerPostForm(THEATRE_CONTROLLER, { method: 'voted_up'}, confirm, 'VOTED UP', 'id_nextVideo');
	function confirm(success) {

	}	
}

function voteDown(){
	callServerPostForm(THEATRE_CONTROLLER, { method: 'voted_down'}, confirm, 'VOTED DOWN', 'id_nextVideo');
	function confirm(success) {

	}	
}

function signOut() {
	callServerPost(SEARCH_CONTROLLER, { method: 'sign_out'}, signOutRedirect, 'SIGNING OUT');
	function signOutRedirect() {
		window.location ='/index.php';
	}
}
