dojo.require("dijit.form.TextBox");
dojo.require("dijit.form.Button");
dojo.require("dijit.form.ValidationTextBox");

var THEATRE_CONTROLLER = 'controllers/theatre_controller.php';
var SEARCH_CONTROLLER = 'controllers/search_controller.php';
var INDEX_CONTROLLER = 'controllers/index_controller.php';
var upvoted = 0;
var downvoted = 0;
var current_id;

dojo.addOnLoad(function() {

	setUpEmbededSWF();	
	
	dojo.addOnWindowUnload(function() {
		exitTheatre();
		
	});	
	
	getTheatres();
	
	

});

function setUpEmbededSWF(){
	var params = { allowScriptAccess: "always" };
	var atts = { id: "myytplayer" };
	swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&version=3&playerapiid=ytplayer",
	                   "ytapiplayer", "748", "495", "8", null, null, params, atts);
	
}


function exitTheatre(){
	callServerPostSync(THEATRE_CONTROLLER, {method: 'exit_theatre'}, confirmLeft, 'EXITING THEATRE' );
	function confirmLeft(id){
		console.log(id);
	}	
}

function getUsersInTheatre(){
	
	callServerPost(THEATRE_CONTROLLER, { method: 'get_users_in_theatre'}, showUsersInTheatre, 'GETTING USERS IN THEATRE');
	function showUsersInTheatre(jsonUser) {//array of usernames
		//jsonUser[i].username
		console.log(jsonUser);
		//dojo.byId('id_usersInTheatre').innerHTML = jsonUser.topic;
	}
}


function onYouTubePlayerReady(playerId){
	   ytplayer = document.getElementById("myytplayer");//get reference to the player
	   ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
	   setInterval(updateRating, 10000);
	   getReelPreview();
	   initializeReel();
}

function initializeReel(){
	var theatreId = document.$_GET['theatre_id'];
	callServerPost(THEATRE_CONTROLLER, { method: 'get_initial_reel', theatre_id: theatreId }, reelResponse, 'INITIALIZING REELS');
	function reelResponse(jsonReel){
		if(jsonReel){
			//exists playable video, begin playing it
			console.log(jsonReel.url);
			console.log(jsonReel.start_time);
			dojo.attr('id_hidden_reel', 'value', jsonReel.id);
			var activeId = 'id_'+jsonReel.id;
			console.log(activeId);
			dojo.attr(activeId, 'class', 'video_prev_container_active');
			
			current_id=jsonReel.id;
			play(jsonReel.url, jsonReel.start_time);
   		    updateRating();

		}		
	}
}

function onytplayerStateChange(newState) {
	if(newState==0){
		   console.log("video finished");
		   loadNextVideo();
	}
}

function loadNextVideo(){
	
	//ask database for next video
	upvoted=0;
	downvoted=0;
	console.log(upvoted);
	console.log(downvoted);
	
	callServerPostForm(THEATRE_CONTROLLER, { method: 'get_next_reel', theatre_id: document.$_GET['theatre_id']}, getNextVideo, 'GETTING NEXT VIDEO ', 'id_nextVideo');
	function getNextVideo(jsonReel) {

		dojo.attr('id_hidden_reel', 'value', jsonReel.id);
		//document.getElementById('now_playing').innerHTML = 'Now Playing:  ' + jsonReel.title;
		activeId = 'id_'+jsonReel.id;
		dojo.attr(activeId, 'class', 'video_prev_container_active');
		currentId = 'id_'+current_id;
		dojo.attr(currentId, 'class', 'video_prev_container');
		console.log(current_id);
		current_id=jsonReel.id;
		console.log(current_id);
		//dojo.attr(current_id, 'class', 'video_prev_container');
		//current_id=jsonReel.id;
		play(jsonReel.url, 0);
	}
	
	updateRating();
}

function getReelPreview(){
	dojo.byId('id_reelPreview').innerHTML = '';
	var theatreId = document.$_GET['theatre_id'];
	var params = { method: 'get_reel_preview', theatre_id: theatreId};
	callServerPost(THEATRE_CONTROLLER, params, reelResponse, 'GETTING REEL PREVIEW');
	function reelResponse(jsonReels){
		if(jsonReels){
			for(i=0; i<jsonReels.length; i++) {
				var container = dojo.create("div", {class:'video_prev_container', id: 'id_'+jsonReels[i].vid_id});
				var container2 = dojo.create("div", {class:'video_prev_inner'}, container);
				var thumbWrapper = dojo.create("div", {class:'video_prev_thumbWrapper'}, container2);
				var idDiv = dojo.create("div", {innerHTML: jsonReels[i].title, class:'video_prev_title' }, container2);
				var thumb = dojo.create("img", {src: stripslashes(jsonReels[i].thumb_url), class:'video_prev_thumb' }, thumbWrapper);	
				//dojo.place(thumbWrapper, container2);
				//dojo.place(container2, container);
				dojo.place(container, dojo.byId('id_reelPreview'));
			}
		}		
	}
}

function play(videoId, startPoint){
	if(ytplayer){
		console.log(videoId);
		console.log(startPoint);
		ytplayer.loadVideoById(videoId, startPoint, "default");
	}
	else{
		console.log("failed to play");
	}
}

function addUrlToPlaylist() {
	
	//get ID out of url
	var url = dojo.attr("new_url", "value");
	var video_id = url.split('v=')[1];
	var ampersandPosition = video_id.indexOf('&');
	if(ampersandPosition != -1){
		video_id = video_id.substring(0, ampersandPosition);
	}
	
	//add ID to database
	newId = video_id;
	var params = { method: 'add_to_playlist', url: newId, theatre_id: document.$_GET['theatre_id'] };
	callServerPostText(THEATRE_CONTROLLER, params , showInPlaylist, 'ADDING VIDEO');
	

}

function showInPlaylist(jsonRT) {
	
	dojo.byId("id_newUrlForm").reset();
	
	//if theater has no videos playing
	if(dojo.attr('id_hidden_reel', 'value') == 0){
		play(newId, 0);
		dojo.attr('id_hidden_reel', 'value', jsonRT.id);
	}
	//ytplayer.loadVideoById(videoId, 0, "medium");
	
	getReelPreview()
	
}

function mute(){
	
	if(ytplayer.isMuted()){
		ytplayer.unMute();
		dojo.attr('mute_button', 'class', 'mute_button_off');
	}
	else{
		ytplayer.mute();
		dojo.attr('mute_button', 'class', 'mute_button_on');
	}
}

function volumeUp(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 100){
		ytplayer.setVolume(vol+10);
	}
}

function volumeDown(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 0){
		console.log("setting volume");
		ytplayer.setVolume(vol-10);
	}
}

function voteUp(){

	//change color
	document.getElementById("vote_up_button").setAttribute("class", "thumbs_up_clicked");
	
	
	if(upvoted==0){

		callServerPostForm(THEATRE_CONTROLLER, {method: 'upvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
		if(downvoted==1){
			//remove previous downvote
			callServerPostForm(THEATRE_CONTROLLER, {method: 'remove_downvote'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
			document.getElementById("vote_down_button").setAttribute("class", "vote_down");

		}
		upvoted=1;
		downvoted=0;
	}
	function confirm(result){
		console.log(result);
	}

}

function voteDown(){
	
	//change color
	document.getElementById("vote_down_button").setAttribute("class", "rotton");
	document.getElementById("vote_up_button").setAttribute("class", "thumbs_up");

	if(downvoted==0){

		callServerPostForm(THEATRE_CONTROLLER, {method: 'downvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
		if(upvoted==1){
			callServerPostForm(THEATRE_CONTROLLER, {method: 'remove_upvote'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
			document.getElementById("vote_up_button").setAttribute("class", "thumbs_up");

		}
		downvoted=1;
		upvoted=0;
	}
	function confirm(result){
		console.log(result);
	}
}

function updateVotes(){
	console.log("updating");
	//var params = { method: 'update_votes', upvotes: upvoted, downvotes: downvoted };
	if(upvoted==1){
		callServerPostForm(THEATRE_CONTROLLER, {method: 'upvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
	}else{
		callServerPostForm(THEATRE_CONTROLLER, {method: 'downvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
	}
//	callServerPostForm(THEATRE_CONTROLLER, params, confirm, 'UPDATING VOTES', 'id_nextVideo');
	//, upvotes: $numUpvotes, downvotes: $numDownvotes}
	function confirm(response){
		console.log("returned from updating votes");
		console.log(response);
	}
}

function updateRating(){
	//updates the theatre reating
	
	callServerPostForm(THEATRE_CONTROLLER, {method: 'update_rating'}, confirm, 'UPDATING RATING', 'id_nextVideo');
	function confirm(response){
		console.log("returned from updating rating");
		console.log(response);
		document.getElementById('id_rating').innerHTML = response+'%';
		//dojo.attr('id_hidden_reel', 'value', jsonReel.id);

	}
}

function getViewers(){
	//returns the number of viewers in the theatre
	callServerPost(THEATRE_CONTROLLER, {method: 'get_viewers'}, confirm, 'GETTING VIEWERS');
	function confirm(response){
		
	}

}

function signOut() {
	callServerPost(SEARCH_CONTROLLER, { method: 'sign_out'}, signOutRedirect, 'SIGNING OUT');
	function signOutRedirect() {
		window.location = '/theatre.php?theatre_id='+ document.$_GET['theatre_id'];
	}
}

function sizeChat() {
	var buttonType = dojo.byId('id_minimize_chat').innerHTML;
	if(buttonType == '-') {
		dojo.style('id_chat_container', 'height', '23px');
		dojo.byId('id_minimize_chat').innerHTML = '+';
	} else {
		dojo.style('id_chat_container', 'height', '200px');
		dojo.byId('id_minimize_chat').innerHTML = '-';
	}
}

function sizeReel() {	
	var buttonType = dojo.byId('id_minimize_reel').innerHTML;
	if(buttonType == '-') {
		dojo.style('id_reel_container', 'height', '23px');
		dojo.byId('id_minimize_reel').innerHTML = '+';
	} else {
		dojo.style('id_reel_container', 'height', '400px');
		dojo.byId('id_minimize_reel').innerHTML = '-';
	}
}

function redirect(id) {
	if(id) {
		console.log(id);
		window.location = '/theatre.php?theatre_id='+ document.$_GET['theatre_id'];
	} else {
		console.log("error returning");
	}
}

function signIn() {
	
	var username = dojo.attr('username_email', 'value');
	var password = dojo.attr('password', 'value');
	
	callServerPostForm(INDEX_CONTROLLER, {method:'sign_in'}, redirect, 'SIGNING IN', 'id_form_signIn');
}


function createAccount() {

	var username = dojo.attr('id_new_username', 'value');
	var email = dojo.attr('id_new_email', 'value');
	var pass = dojo.attr('id_new_password', 'value');
	var verifyPass = dojo.attr('id_verify_password', 'value');	
		
	if(pass == verifyPass){
		dojo.byId('id_join_error').innerHTML = "";
		var params = {method:'create_account'};
		callServerPostForm(INDEX_CONTROLLER, params, redirect, 'CREATING ACCOUNT', 'id_form_create_account');
	}
	else{
		var verifyPass = dojo.attr('id_verify_password', 'value');	
		dojo.byId('id_join_error').innerHTML = "passwords do not match";
	}
}

function displayLogin() {
	
	var display = dojo.style('id_login_box', 'display');
	
	if(display == 'none') {
		dojo.style('id_sign_up_box', 'display', 'none');
		dojo.style('id_login_box', 'display', 'inline');
	} else {
		dojo.style('id_login_box', 'display', 'none');
	}
}

function displaySignUp() {
	var display = dojo.style('id_sign_up_box', 'display');
	
	if(display == 'none') {
		dojo.style('id_login_box', 'display', 'none');
		dojo.style('id_sign_up_box', 'display', 'inline');
	} else {
		dojo.style('id_sign_up_box', 'display', 'none');
	}
}

function getTheatres() {
	callServerPost(SEARCH_CONTROLLER, { method: 'get_all_theatres'}, showAllTheatres, 'GETTING THEATRES');
	function showAllTheatres(jsonTheatres) {
		var allTheatres = "";
		if(jsonTheatres) {
			for(i=0; i<jsonTheatres.length; i++) {
				var event = "goToTheatre(" + jsonTheatres[i].id + ")";
				var	 theatreDiv = dojo.create("div", { onClick: event, class: 'theatreInList' });
				var countHTML = '<div class="reel_count_num">' + jsonTheatres[i].reel_count + '</div>' + ' videos ';
				dojo.create("div", {innerHTML: countHTML, class:'reel_count_container'}, theatreDiv);
				var topicDiv = dojo.create("div", {innerHTML: jsonTheatres[i].topic +'<br/>', class:'topic_container' }, theatreDiv);
				dojo.create("div", {innerHTML: jsonTheatres[i].description, class:'desc_container' }, topicDiv);
				console.log(theatreDiv);
				dojo.place(theatreDiv, dojo.byId('id_allTheatres'));
			}
		}
	}
}


