dojo.require("dijit.form.TextBox");
dojo.require("dijit.form.Button");


var THEATRE_CONTROLLER = 'controllers/theatre_controller.php';
var SEARCH_CONTROLLER = 'controllers/search_controller.php';
var upvoted = 0;
var downvoted = 0;
var voteCount = 0;

dojo.addOnLoad(function() {

	setUpEmbededSWF();	
	
	dojo.addOnWindowUnload(function() {
		exitTheatre();
		
	});	
	
	

});

function setUpEmbededSWF(){
	var params = { allowScriptAccess: "always" };
	var atts = { id: "myytplayer" };
	swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&version=3&playerapiid=ytplayer",
<<<<<<< .mine
	                   "ytapiplayer", "816", "480", "8", null, null, params, atts);
=======
	                   "ytapiplayer", "680", "450", "8", null, null, params, atts);
>>>>>>> .r193
	
}


function exitTheatre(){
	callServerPostSync(THEATRE_CONTROLLER, {method: 'exit_theatre'}, confirmLeft, 'EXITING THEATRE' );
	function confirmLeft(id){
		console.log(id);
	}	
}

function getUsersInTheatre(){
	
	callServerPost(THEATRE_CONTROLLER, { method: 'get_users_in_theatre'}, showUsersInTheatre, 'GETTING USERS IN THEATRE');
	function showUsersInTheatre(jsonUser) {//array of usernames
		//jsonUser[i].username
		console.log(jsonUser);
		//dojo.byId('id_usersInTheatre').innerHTML = jsonUser.topic;
	}
}


function onYouTubePlayerReady(playerId){
	   ytplayer = document.getElementById("myytplayer");//get reference to the player
	   ytplayer.addEventListener("onStateChange", "onytplayerStateChange");
	   getReelPreview();
	   initializeReel();
}

function initializeReel(){
	var theatreId = document.$_GET['theatre_id'];
	callServerPost(THEATRE_CONTROLLER, { method: 'get_initial_reel', theatre_id: theatreId }, reelResponse, 'GETTING NEXT VIDEO');
	function reelResponse(jsonReel){
		if(jsonReel){
			//exists playable video, begin playing it
			console.log(jsonReel.url);
			console.log(jsonReel.start_time);
			dojo.attr('id_hidden_reel', 'value', jsonReel.id);
			play(jsonReel.url, jsonReel.start_time);
   		    updateRating();

		}		
	}
}

function onytplayerStateChange(newState) {
	if(newState==0){
		   console.log("video finished");
		   loadNextVideo();
	}
}

function loadNextVideo(){
	
	//ask database for next video
	upvoted=0;
	downvoted=0;
	console.log(upvoted);
	console.log(downvoted);
	
	callServerPostForm(THEATRE_CONTROLLER, { method: 'get_next_reel', theatre_id: document.$_GET['theatre_id']}, getNextVideo, 'GETTING NEXT VIDEO', 'id_nextVideo');
	function getNextVideo(jsonReel) {

		dojo.attr('id_hidden_reel', 'value', jsonReel.id);
		//document.getElementById('now_playing').innerHTML = 'Now Playing:  ' + jsonReel.title;
		play(jsonReel.url, 0);
	}
	
	updateRating();
}

function getReelPreview(){
	dojo.byId('id_reelPreview').innerHTML = '';
	var theatreId = document.$_GET['theatre_id'];
	var params = { method: 'get_reel_preview', theatre_id: theatreId};
	callServerPost(THEATRE_CONTROLLER, params, reelResponse, 'GETTING REEL PREVIEW');
	function reelResponse(jsonReels){
		if(jsonReels){
			for(i=0; i<jsonReels.length; i++) {
				var container = dojo.create("div", {class:'video_prev_container'});
				var idDiv = dojo.create("div", {innerHTML: jsonReels[i].title, class:'video_prev_title' }, container);
				var thumbWrapper = dojo.create("div", {class:'video_prev_thumbWrapper'});
				var thumb = dojo.create("img", {src: stripslashes(jsonReels[i].thumb_url), class:'video_prev_thumb' }, thumbWrapper);	
				dojo.place(thumbWrapper, container);
				dojo.place(container, dojo.byId('id_reelPreview'));
			}
		}		
	}
}

function play(videoId, startPoint){
	if(ytplayer){
		console.log(videoId);
		console.log(startPoint);
		ytplayer.loadVideoById(videoId, startPoint, "medium");
	}
	else{
		console.log("failed to play");
	}
}

function addUrlToPlaylist() {
	
	//get ID out of url
	var url = dojo.attr("new_url", "value");
	var video_id = url.split('v=')[1];
	var ampersandPosition = video_id.indexOf('&');
	if(ampersandPosition != -1){
		video_id = video_id.substring(0, ampersandPosition);
	}
	
	//add ID to database
	newId = video_id;
	var params = { method: 'add_to_playlist', url: newId, theatre_id: document.$_GET['theatre_id'] };
	callServerPostText(THEATRE_CONTROLLER, params , showInPlaylist, 'ADDING VIDEO');
	

}

function showInPlaylist(jsonRT) {
	
	dojo.byId("id_newUrlForm").reset();
	
	//if theater has no videos playing
	if(dojo.attr('id_hidden_reel', 'value') == 0){
		play(newId, 0);
		dojo.attr('id_hidden_reel', 'value', jsonRT.id);
	}
	//ytplayer.loadVideoById(videoId, 0, "medium");
	
	getReelPreview()
	
}

function mute(){
	
	if(ytplayer.isMuted()){
		ytplayer.unMute();
		document.getElementById('mute_button').innerHTML = 'Mute';
	}
	else{
		ytplayer.mute();
		document.getElementById('mute_button').innerHTML = 'unMute';	
	}
}

function volumeUp(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 100){
		ytplayer.setVolume(vol+10);
	}
}

function volumeDown(){

	var vol = ytplayer.getVolume();
	console.log(vol);
	if(vol != 0){
		console.log("setting volume");
		ytplayer.setVolume(vol-10);
	}
}

function voteUp(){

	//change color
	document.getElementById("vote_up_button").setAttribute("class", "voted");
	if(upvoted==0){

		callServerPostForm(THEATRE_CONTROLLER, {method: 'upvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
		if(downvoted==1){
			//remove previous downvote
			callServerPostForm(THEATRE_CONTROLLER, {method: 'remove_downvote'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
			document.getElementById("vote_down_button").setAttribute("class", "vote_button");

		}
		upvoted=1;
		downvoted=0;
	}
	function confirm(result){
		console.log(result);
	}
	
	voteCount++;
	if(voteCount>=5){
		updateRating();
		voteCount = 0;
	}
}

function voteDown(){
	
	//change color
	document.getElementById("vote_down_button").setAttribute("class", "voted");
	if(downvoted==0){

		callServerPostForm(THEATRE_CONTROLLER, {method: 'downvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
		if(upvoted==1){
			callServerPostForm(THEATRE_CONTROLLER, {method: 'remove_upvote'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
			document.getElementById("vote_up_button").setAttribute("class", "vote_button");

		}
		downvoted=1;
		upvoted=0;
	}
	function confirm(result){
		console.log(result);
	}
	
	voteCount++;
	if(voteCount>=5){
		updateRating();
		voteCount = 0;
	}
}

function updateVotes(){
	console.log("updating");
	//var params = { method: 'update_votes', upvotes: upvoted, downvotes: downvoted };
	if(upvoted==1){
		callServerPostForm(THEATRE_CONTROLLER, {method: 'upvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
	}else{
		callServerPostForm(THEATRE_CONTROLLER, {method: 'downvoted'}, confirm, 'UPDATING VOTES', 'id_nextVideo');
	}
//	callServerPostForm(THEATRE_CONTROLLER, params, confirm, 'UPDATING VOTES', 'id_nextVideo');
	//, upvotes: $numUpvotes, downvotes: $numDownvotes}
	function confirm(response){
		console.log("returned from updating votes");
		console.log(response);
	}
}

function updateRating(){
	callServerPostForm(THEATRE_CONTROLLER, {method: 'update_rating'}, confirm, 'UPDATING RATING', 'id_nextVideo');
	function confirm(response){
		console.log("returned from updating rating");
		console.log(response);
		document.getElementById('id_rating').innerHTML = response+'%';
		//dojo.attr('id_hidden_reel', 'value', jsonReel.id);

	}
}



function signOut() {
	callServerPost(SEARCH_CONTROLLER, { method: 'sign_out'}, signOutRedirect, 'SIGNING OUT');
	function signOutRedirect() {
		window.location ='/index.php';
	}
}
